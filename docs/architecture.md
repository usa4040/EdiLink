# システムアーキテクチャ

## 概要

EdiLinkは、日本のEDINET（電子開示システム）から大量保有報告書データを収集・管理・可視化するフルスタックアプリケーションです。

## システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│                        ユーザー                              │
└────────────────────┬────────────────────────────────────────┘
                     │ HTTP
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                    Next.js 16 (フロントエンド)               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐  │
│  │   React 19   │  │  TypeScript  │  │ Tailwind CSS 4   │  │
│  └──────────────┘  └──────────────┘  └──────────────────┘  │
│                     Port: 3000                               │
└────────────────────┬────────────────────────────────────────┘
                     │ REST API (JSON)
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                    FastAPI (バックエンド)                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐  │
│  │    Pydantic  │  │   SQLAlchemy │  │    slowapi       │  │
│  └──────────────┘  └──────────────┘  └──────────────────┘  │
│                     Port: 8000                               │
└────────────────────┬────────────────────────────────────────┘
                     │ SQL
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                    SQLite データベース                       │
│  - filers (提出者)                                           │
│  - issuers (発行体)                                          │
│  - filings (報告書)                                          │
│  - holding_details (保有詳細)                                │
└─────────────────────────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                    EDINET API                               │
│  - 大量保有報告書データの取得                                 │
│  - 定期的な同期 (sync_edinet.py)                             │
└─────────────────────────────────────────────────────────────┘
```

## データモデル (ER図)

```
┌──────────────┐       ┌──────────────┐       ┌──────────────┐
│    Filer     │       │    Filing    │       │    Issuer    │
├──────────────┤       ├──────────────┤       ├──────────────┤
│ id (PK)      │◄──────┤ id (PK)      │──────►│ id (PK)      │
│ edinet_code  │       │ doc_id       │       │ edinet_code  │
│ name         │       │ filer_id(FK) │       │ name         │
│ sec_code     │       │ issuer_id(FK)│       │ sec_code     │
│ ...          │       │ ...          │       │ ...          │
└──────────────┘       └──────┬───────┘       └──────────────┘
                              │
                              ▼
                     ┌──────────────┐
                     │ HoldingDetail│
                     ├──────────────┤
                     │ id (PK)      │
                     │ filing_id(FK)│
                     │ shares_held  │
                     │ holding_ratio│
                     │ purpose      │
                     └──────────────┘

┌──────────────┐
│  FilerCode   │
├──────────────┤
│ id (PK)      │
│ filer_id(FK) │──► Filer
│ edinet_code  │
│ name         │
└──────────────┘
```

## データフロー

### 1. データ同期フロー

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  sync_edinet.py │────►│   EDINET API    │────►│   レスポンス     │
│                 │     │                 │     │   (JSON)        │
└─────────────────┘     └─────────────────┘     └────────┬────────┘
                                                         │
                                                         ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│    SQLite DB    │◄────│  データパース    │◄────│  データ抽出      │
│                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

### 2. APIリクエストフロー

```
┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│    Client    │───►│   FastAPI    │───►│   CRUD Ops   │───►│  SQLAlchemy  │
│              │    │   Endpoint   │    │              │    │              │
└──────────────┘    └──────────────┘    └──────────────┘    └──────┬───────┘
                                                                    │
                                                                    ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  Pydantic    │◄───│   Response   │◄───│    SQLite    │◄───│   SQL実行    │
│  Schema      │    │   JSON       │    │              │    │              │
└──────────────┘    └──────────────┘    └──────────────┘    └──────────────┘
```

## 主要コンポーネント

### バックエンド

#### `backend/main.py`
- FastAPIアプリケーションのエントリーポイント
- APIエンドポイント定義
- セキュリティ設定（レート制限、CORS、セキュリティヘッダー）

#### `backend/models.py`
- SQLAlchemyモデル定義
- データベーススキーマ
- テーブル間のリレーションシップ

#### `backend/crud.py`
- データベース操作（CRUD）
- ビジネスロジック
- クエリ最適化（Eager Loading）

#### `backend/schemas.py`
- Pydanticモデル
- リクエスト/レスポンスの型定義
- バリデーションルール

### フロントエンド

#### `frontend/src/app/page.tsx`
- メインダッシュボード
- 提出者一覧表示
- 検索・ページネーション

#### `frontend/src/app/components/Sidebar.tsx`
- ナビゲーション
- レスポンシブ対応

#### `frontend/src/app/context/SidebarContext.tsx`
- サイドバーの状態管理
- localStorage連携

## 技術スタック詳細

### バックエンド

| コンポーネント | 技術 | 用途 |
|--------------|------|------|
| Web Framework | FastAPI | REST API |
| ORM | SQLAlchemy 2.0 | データベース操作 |
| Database | SQLite | データ永続化 |
| Validation | Pydantic | 型安全・バリデーション |
| Rate Limiting | slowapi | DoS保護 |
| Security | secure | セキュリティヘッダー |
| Testing | pytest | ユニットテスト |
| Linting | ruff | コード品質 |
| Type Check | mypy | 静的型チェック |

### フロントエンド

| コンポーネント | 技術 | 用途 |
|--------------|------|------|
| Framework | Next.js 16 | Reactフレームワーク |
| UI Library | React 19 | コンポーネント |
| Language | TypeScript 5 | 型安全 |
| Styling | Tailwind CSS 4 | CSSフレームワーク |
| Testing | Vitest | ユニットテスト |
| Testing | @testing-library/react | コンポーネントテスト |

## セキュリティアーキテクチャ

```
┌─────────────────────────────────────────┐
│              クライアント                │
└──────────────────┬──────────────────────┘
                   │ HTTPS
                   ▼
┌─────────────────────────────────────────┐
│              レート制限                  │
│  slowapi (100/50/30/10 req/min)         │
└──────────────────┬──────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────┐
│              CORS制限                    │
│  allow_origins: localhost:3000          │
│  allow_methods: GET                     │
└──────────────────┬──────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────┐
│              入力バリデーション          │
│  - skip/limit範囲制限                   │
│  - search長さ制限                       │
└──────────────────┬──────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────┐
│              セキュリティヘッダー        │
│  X-Content-Type-Options: nosniff        │
│  X-Frame-Options: DENY                  │
│  X-XSS-Protection: 1; mode=block        │
└──────────────────┬──────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────┐
│              アプリケーションロジック     │
└─────────────────────────────────────────┘
```

## CI/CDパイプライン

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  Push/PR │───►│  GitHub  │───►│  Python  │───►│  Node    │
│          │    │  Actions │    │  Checks  │    │  Checks  │
└──────────┘    └──────────┘    └────┬─────┘    └────┬─────┘
                                     │               │
                                     ▼               ▼
                              ┌──────────┐    ┌──────────┐
                              │ ruff     │    │ eslint   │
                              │ mypy     │    │ npm test │
                              │ pytest   │    │ build    │
                              └────┬─────┘    └────┬─────┘
                                   │               │
                                   └───────┬───────┘
                                           │
                                           ▼
                                    ┌────────────┐
                                    │  All Pass  │
                                    │  Merge OK  │
                                    └────────────┘
```

## パフォーマンス最適化

### データベース最適化
- **Eager Loading**: N+1問題解消
- **インデックス**: 検索・フィルタリング最適化
- **ページネーション**: 大規模データの効率的取得

### API最適化
- **レート制限**: リソース保護
- **バリデーション**: 無効リクエストの早期排除
- **型安全性**: mypyによるコンパイル時検証

## スケーリング考慮事項

### 現在のアーキテクチャ（シングルサーバー）
- SQLite: 単一ファイルDB
- 開発・小規模運用に最適

### 将来のスケーリング方向
- **PostgreSQL**: 本番環境への移行
- **Redis**: キャッシュ層追加
- **Docker**: コンテナ化
- **AWS/GCP**: クラウド移行
